name = "root_access_full_stack"
tags = ["example", "security", "api", "graph"]

[[cases]]
name = "metadata_contains_table_function_api"
kind = "schema_metadata"
actor = "root"
sql = "INFO FOR DB;"
contains = ["customer", "fn::format_customer", "v1"]

[[cases]]
name = "root_can_create_customer_with_string_number_date_and_computed"
kind = "schema_behavior"
actor = "root"
action_sql = "CREATE customer:alpha CONTENT { name: 'Alice', age: 27, joined_at: <datetime>'2025-01-15T00:00:00Z' };"
verify_sql = "SELECT name, age, joined_at, tier, created_at FROM customer:alpha;"
expect_success = true

[[cases.assertions]]
path = "0.name"
equals = "Alice"

[[cases.assertions]]
path = "0.age"
equals = 27

[[cases.assertions]]
path = "0.joined_at"
contains = "2025-01-15"

[[cases.assertions]]
path = "0.tier"
equals = "adult"

[[cases.assertions]]
path = "0.created_at"
exists = true

[[cases]]
name = "type_validation_rejects_invalid_number"
kind = "schema_behavior"
actor = "root"
action_sql = "CREATE customer:type_err CONTENT { name: 'TypeError', age: 'not-a-number', joined_at: time::now() };"
expect_success = false
expect_error_contains = "number"

[[cases]]
name = "function_returns_formatted_value"
kind = "sql_expect"
actor = "root"
sql = "RETURN fn::format_customer('Alice', 27);"
allow = true

[[cases.assertions]]
path = ""
equals = "Alice#27"

[[cases]]
name = "root_can_create_graph_edge"
kind = "schema_behavior"
actor = "root"
setup_sql = [
  "CREATE person:alice CONTENT { name: 'Alice' };",
  "CREATE person:bob CONTENT { name: 'Bob' };"
]
action_sql = "RELATE person:alice->follows->person:bob CONTENT { since: <datetime>'2024-01-01T00:00:00Z' };"
verify_sql = "SELECT out, in, since FROM follows WHERE out = person:alice AND in = person:bob;"
expect_success = true

[[cases.assertions]]
path = "0.out"
contains = "person:alice"

[[cases.assertions]]
path = "0.in"
contains = "person:bob"

[[cases.assertions]]
path = "0.since"
contains = "2024-01-01"

[[cases]]
name = "access_user_permissions_matrix"
kind = "permissions_matrix"
actor = "access_user"
table = "customer"
record_id = "alpha"

[[cases.rules]]
action = "select"
allow = true

[[cases.rules]]
action = "update"
allow = true

[[cases.rules]]
action = "delete"
allow = false
error_contains = "permission"

[[cases]]
name = "access_user_cannot_delete_customer"
kind = "sql_expect"
actor = "access_user"
sql = "DELETE customer:alpha;"
allow = false
error_contains = "permission"

# API routes are examples: adjust path/status to match your SurrealDB API surface.
[[cases]]
name = "root_api_health_example"
kind = "api_request"
actor = "root"
method = "GET"
path = "/api/v1/health"
expected_status = 200

[[cases.header_assertions]]
name = "content-type"
exists = true

[[cases]]
name = "access_user_api_profile_example"
kind = "api_request"
actor = "access_user"
method = "GET"
path = "/api/v1/profile"
expected_status = 200

[[cases.header_assertions]]
name = "content-type"
exists = true
